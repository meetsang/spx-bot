{% extends "base.html" %}
{% block content %}
  <h4>Strategy Dashboard</h4>

  <form class="date-form" method="get">
    <div class="row g-2 align-items-end">
      <div class="col-auto">
        <label for="date" class="form-label">Select Date</label>
        <select class="form-select" id="date" name="date">
          {% for d in dates %}
            <option value="{{ d }}" {% if d == selected_date %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">Load</button>
      </div>
    </div>
  </form>

  {% if spx_available or strategy_found %}
    <div id="chart" style="height: 600px; margin-top: 20px;"></div>
    <script>
      const chartData = {{ plotly_data | safe }};
      const layout = {{ plotly_layout | safe }};
      
      // Configure chart options
      const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
        displaylogo: false
      };
      
      // Create the chart
      Plotly.newPlot('chart', chartData, layout, config);
      
      // Add event listener for date form submission to show loading state
      document.querySelector('.date-form').addEventListener('submit', function() {
        const chartDiv = document.getElementById('chart');
        chartDiv.innerHTML = '<div class="d-flex justify-content-center align-items-center" style="height: 600px;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
      });
    </script>
  {% else %}
    <div class="alert alert-warning">No data found for {{ selected_date }}. Please select a different date.</div>
  {% endif %}

  {% if strategy_found %}
    <hr>
    <div class="row">
      <div class="col-md-6">
        <h5>Data Files</h5>
        <div class="d-grid gap-2">
          {% if pnl_file_exists %}
            <a href="{{ pnl_download_url }}" class="btn btn-outline-primary" download>
              <i class="bi bi-download"></i> Download PnL Data (pnl.csv)
            </a>
          {% else %}
            <button class="btn btn-outline-secondary" disabled>
              <i class="bi bi-download"></i> PnL Data (pnl.csv) - Not Available
            </button>
          {% endif %}
          
          {% if quotes_file_exists %}
            <a href="{{ quotes_download_url }}" class="btn btn-outline-primary" download>
              <i class="bi bi-download"></i> Download Quotes Data (quotes.csv)
            </a>
          {% else %}
            <button class="btn btn-outline-secondary" disabled>
              <i class="bi bi-download"></i> Quotes Data (quotes.csv) - Not Available
            </button>
          {% endif %}
        </div>
      </div>
      
      <div class="col-md-6">
        <h5>state.json</h5>
        {% if status_text %}
          <div class="card">
            <div class="card-body">
              <pre class="mb-0" style="max-height: 300px; overflow-y: auto;">{{ status_text }}</pre>
            </div>
          </div>
        {% else %}
          <div class="alert alert-info">No state.json found for {{ selected_date }}.</div>
        {% endif %}
      </div>
    </div>
  {% endif %}
{% endblock %}
